# Template: Short-Form Video (TikTok/Reels/Shorts)
# Format: 1080x1920 (9:16 portrait)
# Duration: 30-60 seconds
# Structure: Hook -> Problem -> Solution -> CTA

version: 1
name: "Short-Form Video Template"
description: "Vertical video for TikTok, Instagram Reels, or YouTube Shorts"

vars:
  project_name: "My Short"
  topic: "the main topic"
  orientation: "portrait"
  tts_server: "http://curiosity:7860"
  reference_audio: "assets/voice-reference.wav"
  reference_text: "This is my voice sample for cloning."
  python_path: ".venv/bin/python"

steps:
  # === Setup ===
  - id: setup_dirs
    kind: ensure_dirs
    dirs:
      - "work/scripts"
      - "work/audio"
      - "work/images"
      - "work/clips"
      - "output"

  # === Hook (5 seconds) - Grab attention ===
  - id: script_hook
    kind: write_file
    depends_on: [setup_dirs]
    path: "work/scripts/hook.txt"
    content: |
      Stop scrolling! Here is something you need to know about {{topic}}.

  - id: tts_hook
    kind: tts_generate
    depends_on: [script_hook]
    resume_output: "work/audio/hook.wav"
    script_path: "work/scripts/hook.txt"
    output_path: "work/audio/hook.wav"
    server: "{{tts_server}}"
    reference_audio: "{{reference_audio}}"
    reference_text: "{{reference_text}}"
    python_path: "{{python_path}}"

  - id: img_hook
    kind: text_to_image
    depends_on: [setup_dirs]
    resume_output: "work/images/hook.png"
    prompt: "Eye-catching visual representing {{topic}}, bold colors, portrait orientation"
    output_path: "work/images/hook.png"
    orientation: portrait
    python_path: "{{python_path}}"

  - id: clip_hook
    kind: run_command
    depends_on: [tts_hook, img_hook]
    resume_output: "work/clips/hook.mp4"
    program: ffmpeg
    args: ["-y", "-loop", "1", "-i", "work/images/hook.png", "-i", "work/audio/hook.wav", "-c:v", "libx264", "-tune", "stillimage", "-c:a", "aac", "-shortest", "work/clips/hook.mp4"]

  # === Problem (10 seconds) ===
  - id: script_problem
    kind: write_file
    depends_on: [setup_dirs]
    path: "work/scripts/problem.txt"
    content: |
      Most people struggle with {{topic}} because they do not know the right approach.

  - id: tts_problem
    kind: tts_generate
    depends_on: [script_problem]
    resume_output: "work/audio/problem.wav"
    script_path: "work/scripts/problem.txt"
    output_path: "work/audio/problem.wav"
    server: "{{tts_server}}"
    reference_audio: "{{reference_audio}}"
    reference_text: "{{reference_text}}"
    python_path: "{{python_path}}"

  - id: img_problem
    kind: text_to_image
    depends_on: [setup_dirs]
    resume_output: "work/images/problem.png"
    prompt: "Person looking frustrated, portrait orientation, relatable"
    output_path: "work/images/problem.png"
    orientation: portrait
    python_path: "{{python_path}}"

  - id: clip_problem
    kind: run_command
    depends_on: [tts_problem, img_problem]
    resume_output: "work/clips/problem.mp4"
    program: ffmpeg
    args: ["-y", "-loop", "1", "-i", "work/images/problem.png", "-i", "work/audio/problem.wav", "-c:v", "libx264", "-tune", "stillimage", "-c:a", "aac", "-shortest", "work/clips/problem.mp4"]

  # === Solution (10 seconds) ===
  - id: script_solution
    kind: write_file
    depends_on: [setup_dirs]
    path: "work/scripts/solution.txt"
    content: |
      Here is the simple trick that changes everything about {{topic}}.

  - id: tts_solution
    kind: tts_generate
    depends_on: [script_solution]
    resume_output: "work/audio/solution.wav"
    script_path: "work/scripts/solution.txt"
    output_path: "work/audio/solution.wav"
    server: "{{tts_server}}"
    reference_audio: "{{reference_audio}}"
    reference_text: "{{reference_text}}"
    python_path: "{{python_path}}"

  - id: img_solution
    kind: text_to_image
    depends_on: [setup_dirs]
    resume_output: "work/images/solution.png"
    prompt: "Lightbulb moment, positive insight, portrait orientation"
    output_path: "work/images/solution.png"
    orientation: portrait
    python_path: "{{python_path}}"

  - id: clip_solution
    kind: run_command
    depends_on: [tts_solution, img_solution]
    resume_output: "work/clips/solution.mp4"
    program: ffmpeg
    args: ["-y", "-loop", "1", "-i", "work/images/solution.png", "-i", "work/audio/solution.wav", "-c:v", "libx264", "-tune", "stillimage", "-c:a", "aac", "-shortest", "work/clips/solution.mp4"]

  # === CTA (5 seconds) ===
  - id: script_cta
    kind: write_file
    depends_on: [setup_dirs]
    path: "work/scripts/cta.txt"
    content: |
      Follow for more tips! Drop a comment if this helped.

  - id: tts_cta
    kind: tts_generate
    depends_on: [script_cta]
    resume_output: "work/audio/cta.wav"
    script_path: "work/scripts/cta.txt"
    output_path: "work/audio/cta.wav"
    server: "{{tts_server}}"
    reference_audio: "{{reference_audio}}"
    reference_text: "{{reference_text}}"
    python_path: "{{python_path}}"

  - id: img_cta
    kind: create_slide
    depends_on: [setup_dirs]
    resume_output: "work/images/cta.png"
    template: title
    text: "Follow for More!"
    output_path: "work/images/cta.png"
    orientation: portrait

  - id: clip_cta
    kind: run_command
    depends_on: [tts_cta, img_cta]
    resume_output: "work/clips/cta.mp4"
    program: ffmpeg
    args: ["-y", "-loop", "1", "-i", "work/images/cta.png", "-i", "work/audio/cta.wav", "-c:v", "libx264", "-tune", "stillimage", "-c:a", "aac", "-shortest", "work/clips/cta.mp4"]

  # === Normalize and Assemble ===
  - id: normalize_hook
    kind: normalize_volume
    depends_on: [clip_hook]
    clip_path: "work/clips/hook.mp4"

  - id: normalize_problem
    kind: normalize_volume
    depends_on: [clip_problem]
    clip_path: "work/clips/problem.mp4"

  - id: normalize_solution
    kind: normalize_volume
    depends_on: [clip_solution]
    clip_path: "work/clips/solution.mp4"

  - id: normalize_cta
    kind: normalize_volume
    depends_on: [clip_cta]
    clip_path: "work/clips/cta.mp4"

  - id: concat_final
    kind: video_concat
    depends_on: [normalize_hook, normalize_problem, normalize_solution, normalize_cta]
    clips:
      - "work/clips/hook.mp4"
      - "work/clips/problem.mp4"
      - "work/clips/solution.mp4"
      - "work/clips/cta.mp4"
    output_path: "output/{{project_name}}.mp4"
    reencode: true
